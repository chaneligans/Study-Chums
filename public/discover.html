<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Discover | Study Chums</title>
    <link rel="icon" href="images/favicon.ico">
    <link rel="stylesheet" href="main.css">

    <!-- IMPORT ICONS -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">

    <!-- ??? -->
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- jQuery IMPORT -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- CHECK IF USED IS LOGGED IN -->
    <script type="text/javascript" src="scripts/check_login.js"></script>
    <script>//window.onload = checkLogin;</script>

    <!-- FACEBOOK SIGN OUT-->
    <script type="text/javascript" src="scripts/facebook_logout.js"></script>

    <!-- firebase IMPORT -->
    <script src="https://www.gstatic.com/firebasejs/5.8.2/firebase.js"></script>
    <script type="text/javascript" src="scripts/firebase-config.js"></script>
    <script>firebase.initializeApp(config);</script><!--Initialize Firebase-->

    <!-- search -->
    <script>
      function showSearchResults(results) {
          var html = '<table id="results">';
          var index;
          var img;
          var name;
          var major;

          // iterate through and add a table row for each user (result)
          results.forEach(function(result) {
            index = result[0];
            img = result[1];
            name = result[2];
            major = result[3];

            html += '<tr class="resultRow">';
              html += '<td class="resultUserImage"><img src="' + img + '"></td>';
              html += '<td class="resultUserName"><h2 id="resultUserName0">' + name + '</h2></td>';
              html += '<td class="resultUserMajor"><h3 id="resultUserMajor0">' + major + '</h3></td>';
            html += '</tr>'
          });

          html += '</table>'; 

          document.getElementById("searchResults").innerHTML = html;
          $( "#searchResults" ).load( html, function() {
            console.log( "Load was performed." );
          });
        }

      function Search() {
      $('html').addClass('waiting');
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          let value = document.getElementById("query").value;   // value
          let option = document.getElementById("option").value; // dropdown
          
          var results = [];
          
          // execute only if something is there
          if (option === 'name') {
            if (value !== "") {SearchName(value);}
          }
          else if (option === 'major') {
            if (value !== "") {results = SearchMajor(value);}
          }
          else {
            alert('Invalid!');
          }

          console.log("Search sent to database.");
          

          
        } else {
          console.log("Who are you? And why do you have access to this?");
        }
      });
    }

    function getUserData(childSnapshotValue) {
      var photo = childSnapshotValue.p1Url + " ";
      var data = [childSnapshotValue.index, photo, childSnapshotValue.name, childSnapshotValue.Major];
      return data;
    }

    function SearchName(name_in){
      var results = [];
      firebase.database().ref('Users/').orderByChild("name")
      .equalTo(name_in).once('value',function(snapshot){                
        var data;

        snapshot.forEach(function(childSnapshot) {
          var key = childSnapshot.key;
          var childData = childSnapshot.val();
                  
          data = getUserData(childData);
          results.push(data);

        });
        Promise.all(results).then(result => {
          console.log('Results found: ' + result.length);
          if (results.length > 0) {     
            showSearchResults(results);
          }
        });
      }).catch(function(error) {
        console.log("Error getting results: ", error);
      });
    }
    function SearchMajor(major_in){
      var results = [];
      firebase.database().ref('Users/').orderByChild("Major")
      .equalTo(major_in).once('value',function(snapshot){                
        var data;

        snapshot.forEach(function(childSnapshot) {
          var key = childSnapshot.key;
          var childData = childSnapshot.val();
                  
          data = getUserData(childData);
          results.push(data);

        });
        Promise.all(results).then(result => {
          console.log('Results found: ' + result.length);
          if (results.length > 0) {     
            showSearchResults(results);
          }
        });
      }).catch(function(error) {
        console.log("Error getting results: ", error);
      });
    }
    </script>
  </head>
  <body>
    <!-- WRAPPER (WHITE BOX) -->
    <div id="wrapper">
      <!-- NAVIGATION MENU -->
      <nav>
        <button id="menubutton" class="accordion">Menu</button>
        <ul class="panel">
          <li><a href="home.html" class="nav-item">Home</a></li>
          <li><a href="discover.html" class="nav-item">Discover</a></li>
          <li><a href="profile.html" class="nav-item">Profile</a></li>
          <li><a href="messages.html" class="nav-item">Messages</a></li>
          <li><a href="chums.html" class="nav-item">Chums</a></li>
          <li><a href="applications.html" class="nav-item">Applications</a></li>
          <li><a class="nav-item" onclick="facebookSignOut();">Sign Out</a></li>
        </ul>
      </nav>
      <!-- END OF NAVIGATION MENU -->

      <!-- CONTENT (search bar, profiles) -->
      <div id="content">
        <div id="description">
          <h1>Search for Chums</h1>
        </div>
        <div class="searchBar">
          <div class="container">
            <div class="search">
              <input id="query" type="text" class="searchTerm" placeholder="What are you looking for?">
              <select id="option" class="searchOptions">
                <option value="name">Search by Name</option>
                <option value="major">Search by Major</option>
              </select>
                  <button type="submit" class="searchButton" onclick="Search();">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- END CONTENT-->

      <!-- FOOTER -->
      <footer>
        Designed and Developed by Team Motivation 2019
      </footer>
      <!-- END FOOTER -->
    </div>
    <!-- END WRAPPER (WHITE BOX) -->

    <script type="text/javascript" src="scripts/toggle_bio.js"></script>
  </body>
</html>